### 접속 정보

ssh root@localhost -p 60010

ssh root@localhost -p 60101

ssh root@localhost -p 60102

ssh root@localhost -p 60103

vagrant



### [master]

kubectl get node



## kubectl config

### [worker3]

 scp root@192.168.1.10:/etc/kubernetes/admin.conf .

[root@w3-k8s ~]# ll
합계 12
-rw-------. 1 root root 5452 10월 22 22:09 admin.conf
-rw-------. 1 root root 1377  9월 15  2019 anaconda-ks.cfg



[root@w3-k8s ~]# kubectl get nodes --kubeconfig admin.conf
NAME     STATUS   ROLES    AGE   VERSION
m-k8s    Ready    master   46m   v1.18.4
w1-k8s   Ready    <none>   43m   v1.18.4
w2-k8s   Ready    <none>   40m   v1.18.4
w3-k8s   Ready    <none>   37m   v1.18.4







## kubelet


### [master]

[root@m-k8s 3.1.6]# pwd
/root/_Book_k8sInfra/ch3/3.1.6
[root@m-k8s 3.1.6]# kubectl apply -f nginx-pod.yaml
pod/nginx-pod create

[root@m-k8s 3.1.6]# kubectl get pods
NAME        READY   STATUS    RESTARTS   AGE
nginx-pod   1/1     Running   0          18s
[root@m-k8s 3.1.6]# kubectl get pods -o wide
NAME        READY   STATUS    RESTARTS   AGE   IP               NODE     NOMINATED NODE   READINESS GATES
nginx-pod   1/1     Running   0          26s   172.16.221.129   w1-k8s   <none>           <none>



보면 worker1에 존재하는 것을 확인

worker1로 접속해서 kubelet 서비스를 멈춤



### [worker1]

[root@w1-k8s ~]# systemctl stop kubelet





다시 마스터 노드에 접속해서 삭제함.

### [master]

[root@m-k8s 3.1.6]# kubectl get pods
NAME        READY   STATUS    RESTARTS   AGE
nginx-pod   1/1     Running   0          5m8s
[root@m-k8s 3.1.6]# kubectl delete pod nginx-pod
pod "nginx-pod" deleted





하지만 시간이 오래 지나도록 삭제되지 않는 것을 확인할 수 있음 control c를 눌러 취소하고 파드 상태 확인



NAME        READY   STATUS        RESTARTS   AGE     IP               NODE     NOMINATED NODE   READINESS GATES
nginx-pod   1/1     Terminating   0          9m41s   172.16.221.129   w1-k8s   <none>           <none>



보면 터미네이팅 되고 있지만 삭제가 안된다 이유는 위치하고 있는 worker1의 kubelet 이 동작을 멈췄기 때문. 선장이 부재중이라 pod에게 명령을 전달할 오브젝트가 없다. 다시 워커1으로 가서 kubelet을 올림



### [worker1]

[root@w1-k8s ~]# systemctl start kubelet



### [master]

마스터에서 다시 파드를 확인해보면

[root@m-k8s 3.1.6]# kubectl get pods -o wide
NAME        READY   STATUS        RESTARTS   AGE   IP               NODE     NOMINATED NODE   READINESS GATES
nginx-pod   0/1     Terminating   0          12m   172.16.221.129   w1-k8s   <none>           <none>
[root@m-k8s 3.1.6]# kubectl get pods -o wide
No resources found in default namespace.



삭제되고 있는 것을 확인할 수 있다.



kubelet은 파드의 상태를 관리한다.



## kubeproxy

이번에는 쿠베 프록시를 알아보자



### [master]

[root@m-k8s ~]# cd _Book_k8sInfra/ch3/3.1.6
[root@m-k8s 3.1.6]# ls
nginx-pod.yaml
[root@m-k8s 3.1.6]# kubectl apply -f nginx-pod.yaml
pod/nginx-pod created
[root@m-k8s 3.1.6]# kubectl get pods -o wide
NAME        READY   STATUS    RESTARTS   AGE   IP               NODE     NOMINATED NODE   READINESS GATES
nginx-pod   1/1     Running   0          30s   172.16.103.129   w2-k8s   <none>           <none>



```
[root@m-k8s 3.1.6]# curl 172.16.103.129
<!DOCTYPE html>
<html>
<head>
<title>Welcome to nginx!</title>
<style>
html { color-scheme: light dark; }
body { width: 35em; margin: 0 auto;
font-family: Tahoma, Verdana, Arial, sans-serif; }
</style>
</head>
<body>
<h1>Welcome to nginx!</h1>
<p>If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.</p>

<p>For online documentation and support please refer to
<a href="http://nginx.org/">nginx.org</a>.<br/>
Commercial support is available at
<a href="http://nginx.com/">nginx.com</a>.</p>

<p><em>Thank you for using nginx.</em></p>
</body>
</html>
```



### [worker2]

워커노드 2에서 br_netfiter 명령으로 파드가 위치한 워커노드에서 br_netfiter  삭제



[root@w2-k8s ~]# modprobe -r br_netfilter

[root@w2-k8s ~]# systemctl restart network



### [master] 

에서 다시 아까 페이지 호출

[root@m-k8s 3.1.6]# curl 172.16.103.129
curl: (7) Failed connect to 172.16.103.129:80; 연결 시간 초과



호출안되는 것 확인

이유 : 쿠베프록시가 이용하는 br_netfilter 가 문제있어서 이다



다시 원복

### [worker2]

[root@w2-k8s ~]# modprobe  br_netfilter

[root@w2-k8s ~]# reboot







### [master]

[root@m-k8s 3.1.6]# kubectl get pods
NAME        READY   STATUS      RESTARTS   AGE
nginx-pod   0/1     Completed   0          9m54s
[root@m-k8s 3.1.6]# kubectl get pods
NAME        READY   STATUS    RESTARTS   AGE
nginx-pod   1/1     Running   1          10m





몇분있다 확인하면 다시 올라온걸 확인 호출



[root@m-k8s 3.1.6]# kubectl get pods -o wide
NAME        READY   STATUS    RESTARTS   AGE   IP               NODE     NOMINATED NODE   READINESS GATES
nginx-pod   1/1     Running   1          10m   172.16.103.130   w2-k8s   <none>           <none>





```root@m-k8s 3.1.6]# curl 172.16.103.130
<!DOCTYPE html>
<html>
<head>
<title>Welcome to nginx!</title>
<style>
html { color-scheme: light dark; }
body { width: 35em; margin: 0 auto;
font-family: Tahoma, Verdana, Arial, sans-serif; }
</style>
</head>
<body>
<h1>Welcome to nginx!</h1>
<p>If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.</p>

<p>For online documentation and support please refer to
<a href="http://nginx.org/">nginx.org</a>.<br/>
Commercial support is available at
<a href="http://nginx.com/">nginx.com</a>.</p>

<p><em>Thank you for using nginx.</em></p>
</body>
</html>
[root@m-k8s 3.1.6]#
```



삭제후 다음 작업

[root@m-k8s 3.1.6]# kubectl delete -f nginx-pod.yaml
pod "nginx-pod" deleted





## run 생성

### [master]

[root@m-k8s 3.1.6]# kubectl run nginx-pod --image=nginx
pod/nginx-pod created

[root@m-k8s 3.1.6]# kubectl get pod
NAME        READY   STATUS    RESTARTS   AGE
nginx-pod   1/1     Running   0          12s



## craete 생성

### [master]

[root@m-k8s 3.1.6]# kubectl create nginx --image=nginx
Error: unknown flag: --image
See 'kubectl create --help' for usage



이대로 하면 안됨 create 는 deploy 로 생성

[root@m-k8s 3.1.6]# kubectl create deploy dpy-nginx --image=nginx
deployment.apps/dpy-nginx created



[root@m-k8s 3.1.6]# kubectl get deploy
NAME        READY   UP-TO-DATE   AVAILABLE   AGE
dpy-nginx   1/1     1            1           29s
[root@m-k8s 3.1.6]# kubectl get pods
NAME                       READY   STATUS    RESTARTS   AGE
dpy-nginx-c8d778df-fkhqc   1/1     Running   0          34s
nginx-pod                  1/1     Running   0          2m52s







## scale



deployment 없이 배포한 것은 scale  up 하지 못함

[root@m-k8s 3.1.6]# kubectl scale pod nginx-pod --replicas=3
Error from server (NotFound): the server could not find the requested resource



deployment 있게 배포 한것은  scale 됨

[root@m-k8s 3.1.6]# kubectl scale deploy dpy-nginx  --replicas=3
deployment.apps/dpy-nginx scaled
[root@m-k8s 3.1.6]# kubectl get pods
NAME                       READY   STATUS              RESTARTS   AGE
dpy-nginx-c8d778df-5s7cd   0/1     ContainerCreating   0          7s
dpy-nginx-c8d778df-fkhqc   1/1     Running             0          9m57s
dpy-nginx-c8d778df-r5bwh   1/1     Running             0          7s

[root@m-k8s 3.1.6]# kubectl get pods -o wide
NAME                       READY   STATUS    RESTARTS   AGE   IP               NODE     NOMINATED NODE   READINESS GATES
dpy-nginx-c8d778df-5s7cd   1/1     Running   0          48s   172.16.132.3     w3-k8s   <none>           <none>
dpy-nginx-c8d778df-fkhqc   1/1     Running   0          10m   172.16.221.130   w1-k8s   <none>           <none>
dpy-nginx-c8d778df-r5bwh   1/1     Running   0          48s   172.16.103.132   w2-k8s   <none>           <none>
nginx-pod                  1/1     Running   0          12m   172.16.103.131   w2-k8s   <none>           <none>



[root@m-k8s 3.1.6]# kubectl delete deploy dpy-nginx
deployment.apps "dpy-nginx" deleted
[root@m-k8s 3.1.6]# kubectl get pods
NAME        READY   STATUS    RESTARTS   AGE
nginx-pod   1/1     Running   0          13mspec:  replicas: 1  selector:    matchLabels:      app: nginx  template:    metadata:      labels:        app: nginx    spec:      containers:      - name: echo-hname        image: sysnet4admin/echo-hname ~







## yaml 파일

echo-hname.yaml

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: echo-hname
  labels:
    app: nginx
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: echo-hname
        image: sysnet4admin/echo-hname
```



[root@m-k8s 3.2.4]# kubectl apply -f echo-hname.yaml
deployment.apps/echo-hname created



yaml 파일  수정

spec:
  replicas: 1
  selector:



하나로 바뀜

[root@m-k8s 3.2.4]# kubectl apply -f echo-hname.yaml
deployment.apps/echo-hname configured
[root@m-k8s 3.2.4]# kubectl get pods
NAME                        READY   STATUS        RESTARTS   AGE
echo-hname-7894b67f-7jlqr   1/1     Running       0          67s
echo-hname-7894b67f-ll85c   0/1     Terminating   0          67s



## version

사용가능한 api 버전 확인



[root@m-k8s 3.2.4]# kubectl api-versions
admissionregistration.k8s.io/v1
admissionregistration.k8s.io/v1beta1
apiextensions.k8s.io/v1
apiextensions.k8s.io/v1beta1
apiregistration.k8s.io/v1
apiregistration.k8s.io/v1beta1
apps/v1
authentication.k8s.io/v1
authentication.k8s.io/v1beta1
authorization.k8s.io/v1
authorization.k8s.io/v1beta1
autoscaling/v1
autoscaling/v2beta1
autoscaling/v2beta2
batch/v1
batch/v1beta1
certificates.k8s.io/v1beta1
coordination.k8s.io/v1
coordination.k8s.io/v1beta1
crd.projectcalico.org/v1
discovery.k8s.io/v1beta1
events.k8s.io/v1beta1
extensions/v1beta1
networking.k8s.io/v1
networking.k8s.io/v1beta1
node.k8s.io/v1beta1
policy/v1beta1
rbac.authorization.k8s.io/v1
rbac.authorization.k8s.io/v1beta1
scheduling.k8s.io/v1
scheduling.k8s.io/v1beta1
storage.k8s.io/v1
storage.k8s.io/v1beta1
v1





## exec 

[root@m-k8s 3.2.4]# kubectl exec -it nginx-pod -- /bin/bash



-- 은 인자값을 나누고 싶을 때 사용

[root@m-k8s 3.2.4]# kubectl exec -it nginx-pod -- ls -l /run
total 4
drwxrwxrwt. 2 root root  6 Oct 11 00:00 lock
-rw-r--r--. 1 root root  2 Oct 22 15:12 nginx.pid
drwxr-xr-x. 4 root root 39 Oct 22 15:12 secrets
-rw-rw-r--. 1 root utmp  0 Oct 11 00:00 utmp



## 쿠버네티스 자동복구



[root@m-k8s 3.2.4]# kubectl get pods -o wide
NAME                        READY   STATUS    RESTARTS   AGE     IP               NODE     NOMINATED NODE   READINESS GATES
echo-hname-7894b67f-7jlqr   1/1     Running   0          14m     172.16.132.4     w3-k8s   <none>           <none>
nginx-pod                   1/1     Running   0          6m44s   172.16.103.134   w2-k8s   <none>



root@nginx-pod:/# cat /run/nginx.pid
1



시간 확인

root@nginx-pod:/# ls -l /run/nginx.pid
-rw-r--r--. 1 root root 2 Oct 22 15:12 /run/nginx.pid



다른 창하나 키우고

[root@m-k8s ~]# i=1; while true; do sleep; echo $((i++)) `curl --silent 172.16.103.134 | grep title`; done

```
sleep: missing operand
Try 'sleep --help' for more information.
12557 <title>Welcome to nginx!</title>
sleep: missing operand
Try 'sleep --help' for more information.
```



반복 되는 거 확인



다른 창에서

root@nginx-pod:/# kill 1
root@nginx-pod:/# command terminated with exit code 137



root@nginx-pod:/#  ls -l /run/nginx.pid
-rw-r--r--. 1 root root 2 Oct 22 15:21 /run/nginx.pid



시간이 업데이트 됨

생성된 시간 확인





# cordon vs drain vs taint

* cordon : 지정된 노드에 더 이상 파드들이 스케줄링 되어서 실행되지 않도록 함

* drain : 
* taint : 



## cordon

: 문제가 생길 가능성이 있는 노드인지 판단



[root@m-k8s 3.2.4]# kubectl apply -f echo-hname.yaml
deployment.apps/echo-hname created
[root@m-k8s 3.2.4]# kubectl scale deploy echo-hname --replicas=9
deployment.apps/echo-hname scaled



[root@m-k8s 3.2.4]# kubectl get pods -o=custom-columns=NAME:.metadata.name,IP:.status.podIP,STATUS:.status.phase,NODE:.spec.nodeName
NAME                        IP               STATUS    NODE
echo-hname-7894b67f-2f598   172.16.103.135   Running   w2-k8s
echo-hname-7894b67f-6hbdr   172.16.103.137   Running   w2-k8s
echo-hname-7894b67f-j7rld   172.16.132.7     Running   w3-k8s
echo-hname-7894b67f-kbk9j   172.16.221.134   Running   w1-k8s
echo-hname-7894b67f-lnw42   172.16.132.6     Running   w3-k8s
echo-hname-7894b67f-szsr7   172.16.103.136   Running   w2-k8s
echo-hname-7894b67f-tkc89   172.16.221.135   Running   w1-k8s
echo-hname-7894b67f-v85n9   172.16.132.5     Running   w3-k8s
echo-hname-7894b67f-vjbj4   172.16.221.133   Running   w1-k8s





노드에 파드 할당 되지 않게 설정 : 현재 상태 보존

[root@m-k8s ch3]# kubectl cordon w3-k8s
node/w3-k8s cordoned



[root@m-k8s ch3]# kubectl uncordon w3-k8s
node/w3-k8s uncordoned









## drain

[root@m-k8s ch3]# kubectl drain w3-k8s
node/w3-k8s already cordoned
error: unable to drain node "w3-k8s", aborting command...

There are pending nodes to be drained:
 w3-k8s
cannot delete Pods not managed by ReplicationController, ReplicaSet, Job, DaemonSet or StatefulSet (use --force to override): default/nginx-pod
cannot delete DaemonSet-managed Pods (use --ignore-daemonsets to ignore): kube-system/calico-node-9sxmv, kube-system/kube-proxy-pjjvf









